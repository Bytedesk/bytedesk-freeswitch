# FreeSWITCH Docker Image Build and Push Workflow
# Ëá™Âä®ÊûÑÂª∫ FreeSWITCH Docker ÈïúÂÉèÂπ∂Êé®ÈÄÅÂà∞ Docker Hub ÂíåÈòøÈáå‰∫ëÈïúÂÉè‰ªìÂ∫ì

name: Build FreeSWITCH Docker

on:
  push:
    tags:
      # ÂåπÈÖç freeswitch-v ÂºÄÂ§¥ÁöÑÊ†áÁ≠æÔºå‰æãÂ¶Ç: freeswitch-v1.10.12
      - 'freeswitch-v*'
    paths:
      # ÂΩì‰ª•‰∏ãË∑ØÂæÑÂèëÁîüÂèòÂåñÊó∂Ëß¶Âèë
      - 'deploy/freeswitch/docker/**'
  workflow_dispatch:
    # ÊîØÊåÅÊâãÂä®Ëß¶Âèë
    inputs:
      version:
        description: 'FreeSWITCH version to build (e.g., 1.10.12)'
        required: true
        default: '1.10.12'
      push_to_registry:
        description: 'Push to Docker registries'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# Ê∑ªÂä†ÊùÉÈôêÈÖçÁΩÆ
permissions:
  contents: write
  packages: write

env:
  # ÈïúÂÉèÂêçÁß∞
  IMAGE_NAME: bytedesk/freeswitch
  ALIYUN_IMAGE_NAME: registry.cn-hangzhou.aliyuncs.com/bytedesk/freeswitch
  # FreeSWITCH ÁâàÊú¨
  FREESWITCH_VERSION: v1.10.12

jobs:
  build-and-push:
    name: Build and Push FreeSWITCH Docker Image
    runs-on: ubuntu-latest
    
    steps:
      # 1. Ê£ÄÂá∫‰ª£Á†Å
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ÊèêÂèñÁâàÊú¨Âè∑
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # ‰ªéÊ†áÁ≠æÊèêÂèñÁâàÊú¨Âè∑Ôºå‰æãÂ¶Ç: freeswitch-v1.10.12 -> 1.10.12
            VERSION="${GITHUB_REF_NAME#freeswitch-v}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building FreeSWITCH version: ${VERSION}"

      # 3. ËÆæÁΩÆ QEMU (ÊîØÊåÅÂ§öÂπ≥Âè∞ÊûÑÂª∫)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 4. ËÆæÁΩÆ Docker Buildx
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: latest
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      # 5. ÁôªÂΩï Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: bytedesk
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
          logout: false

      # 6. ÁôªÂΩïÈòøÈáå‰∫ë Docker Registry
      - name: Login to Aliyun Docker Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_DOCKER_USERNAME }}
          password: ${{ secrets.ALIYUN_DOCKER_PASSWORD }}
          logout: false

      # 7. ÂáÜÂ§áÊûÑÂª∫ÂÖÉÊï∞ÊçÆ
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.IMAGE_NAME }}
            ${{ env.ALIYUN_IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.version.outputs.VERSION }}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=ByteDesk FreeSWITCH
            org.opencontainers.image.description=FreeSWITCH Docker image for ByteDesk Call Center
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.vendor=ByteDesk
            maintainer=ByteDesk <support@bytedesk.com>

      # 8. ÊûÑÂª∫Âπ∂Êé®ÈÄÅÂà∞ÈòøÈáå‰∫ë Docker Registry
      - name: Build and push to Aliyun Docker Registry
        uses: docker/build-push-action@v6
        with:
          context: ./deploy/freeswitch/docker
          file: ./deploy/freeswitch/docker/Dockerfile
          builder: ${{ steps.buildx.outputs.name }}
          platforms: linux/amd64
          push: ${{ github.event.inputs.push_to_registry != 'false' }}
          tags: |
            ${{ env.ALIYUN_IMAGE_NAME }}:latest
            ${{ env.ALIYUN_IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          build-args: |
            FREESWITCH_VERSION=${{ env.FREESWITCH_VERSION }}
            BUILD_DATE=${{ steps.meta.outputs.created }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.version.outputs.VERSION }}

      # 9. ÊûÑÂª∫Âπ∂Êé®ÈÄÅÂà∞ Docker Hub
      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: ./deploy/freeswitch/docker
          file: ./deploy/freeswitch/docker/Dockerfile
          builder: ${{ steps.buildx.outputs.name }}
          platforms: linux/amd64
          push: ${{ github.event.inputs.push_to_registry != 'false' }}
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          build-args: |
            FREESWITCH_VERSION=${{ env.FREESWITCH_VERSION }}
            BUILD_DATE=${{ steps.meta.outputs.created }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.version.outputs.VERSION }}

      # 10. ÂàõÂª∫ GitHub ReleaseÔºà‰ªÖÂú®Êé®ÈÄÅÊ†áÁ≠æÊó∂Ôºâ
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/freeswitch-v')
        uses: softprops/action-gh-release@v1
        with:
          name: FreeSWITCH v${{ steps.version.outputs.VERSION }}
          body: |
            ## FreeSWITCH Docker ÈïúÂÉèÂèëÂ∏É
            
            **ÁâàÊú¨**: ${{ steps.version.outputs.VERSION }}  
            **FreeSWITCH ÁâàÊú¨**: 1.10.12  
            **Âü∫Á°ÄÈïúÂÉè**: Ubuntu 22.04 LTS
            
            ### üì¶ Docker ÈïúÂÉè
            
            #### Docker Hub
            ```bash
            docker pull bytedesk/freeswitch:${{ steps.version.outputs.VERSION }}
            # ÊàñËÄÖ
            docker pull bytedesk/freeswitch:latest
            ```
            
            #### ÈòøÈáå‰∫ëÈïúÂÉè‰ªìÂ∫ìÔºà‰∏≠ÂõΩÂ§ßÈôÜÁî®Êà∑Êé®ËçêÔºâ
            ```bash
            docker pull registry.cn-hangzhou.aliyuncs.com/bytedesk/freeswitch:${{ steps.version.outputs.VERSION }}
            # ÊàñËÄÖ
            docker pull registry.cn-hangzhou.aliyuncs.com/bytedesk/freeswitch:latest
            ```
            
            ### üöÄ Âø´ÈÄüÂêØÂä®
            
            ```bash
            docker run -d \
              --name freeswitch-bytedesk \
              -p 5060:5060/tcp -p 5060:5060/udp \
              -p 5080:5080/tcp -p 5080:5080/udp \
              -p 8021:8021 \
              -p 7443:7443 \
              -p 16384-32768:16384-32768/udp \
              -e FREESWITCH_ESL_PASSWORD=your-password \
              -e TZ=Asia/Shanghai \
              bytedesk/freeswitch:${{ steps.version.outputs.VERSION }}
            ```
            
            ### üìã ÂäüËÉΩÁâπÊÄß
            
            - ‚úÖ Âü∫‰∫é Ubuntu 22.04 LTS
            - ‚úÖ FreeSWITCH 1.10.12 ÁâàÊú¨
            - ‚úÖ ÂåÖÂê´ mod_mariadb Ê®°Âùó
            - ‚úÖ ÊîØÊåÅ MySQL/MariaDB Êï∞ÊçÆÂ∫ì
            - ‚úÖ ÊîØÊåÅ WebRTC
            - ‚úÖ ÊîØÊåÅ SIP TLS Âä†ÂØÜ
            - ‚úÖ ÂÅ•Â∫∑Ê£ÄÊü•ÈÖçÁΩÆ
            - ‚úÖ ÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆ
            
            ### üîß ÁéØÂ¢ÉÂèòÈáè
            
            | ÂèòÈáèÂêç | ËØ¥Êòé | ÈªòËÆ§ÂÄº |
            |--------|------|--------|
            | FREESWITCH_ESL_PASSWORD | ESL ËøûÊé•ÂØÜÁ†Å | - |
            | FREESWITCH_DOMAIN | SIP ÂüüÂêç | - |
            | FREESWITCH_EXTERNAL_IP | Â§ñÈÉ® IP (NAT) | - |
            | TZ | Êó∂Âå∫ | Asia/Shanghai |
            
            ### üìö ÊñáÊ°£
            
            - [ÂÆåÊï¥ÊñáÊ°£](https://github.com/${{ github.repository }}/tree/main/deploy/freeswitch/docker/README.md)
            - [Âø´ÈÄüÂºÄÂßã](https://github.com/${{ github.repository }}/tree/main/deploy/freeswitch/docker/QUICKSTART.md)
            - [FreeSWITCH ÂÆòÊñπÊñáÊ°£](https://freeswitch.org/confluence/)
            
            ### üîó Áõ∏ÂÖ≥ÈìæÊé•
            
            - Docker Hub: https://hub.docker.com/r/bytedesk/freeswitch
            - ÈòøÈáå‰∫ëÈïúÂÉè: https://cr.console.aliyun.com/repository/cn-hangzhou/bytedesk/freeswitch
            
            ---
            
            **ÊûÑÂª∫Êó∂Èó¥**: ${{ steps.meta.outputs.created }}  
            **Êèê‰∫§ SHA**: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 11. ËæìÂá∫ÊûÑÂª∫‰ø°ÊÅØ
      - name: Build Summary
        run: |
          echo "## üéâ FreeSWITCH Docker ÈïúÂÉèÊûÑÂª∫ÊàêÂäü" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ ÈïúÂÉè‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ÁâàÊú¨**: ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **FreeSWITCH**: 1.10.12" >> $GITHUB_STEP_SUMMARY
          echo "- **Âπ≥Âè∞**: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- **ÊûÑÂª∫Êó∂Èó¥**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üê≥ Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull bytedesk/freeswitch:${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚òÅÔ∏è ÈòøÈáå‰∫ëÈïúÂÉè‰ªìÂ∫ì" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull registry.cn-hangzhou.aliyuncs.com/bytedesk/freeswitch:${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Áõ∏ÂÖ≥ÈìæÊé•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub](https://hub.docker.com/r/bytedesk/freeswitch)" >> $GITHUB_STEP_SUMMARY
          echo "- [ÈòøÈáå‰∫ëÈïúÂÉè](https://cr.console.aliyun.com/repository/cn-hangzhou/bytedesk/freeswitch)" >> $GITHUB_STEP_SUMMARY
          echo "- [‰ΩøÁî®ÊñáÊ°£](https://github.com/${{ github.repository }}/tree/main/deploy/freeswitch/docker)" >> $GITHUB_STEP_SUMMARY

  # ÂèØÈÄâÔºöÊµãËØïÊûÑÂª∫ÁöÑÈïúÂÉè
  test-image:
    name: Test FreeSWITCH Docker Image
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event.inputs.push_to_registry != 'false'
    
    steps:
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#freeswitch-v}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Pull and test Docker image
        run: |
          echo "Testing Docker Hub image..."
          docker pull bytedesk/freeswitch:${{ steps.version.outputs.VERSION }}
          
          echo "Starting container..."
          docker run -d --name freeswitch-test \
            -e FREESWITCH_ESL_PASSWORD=test123 \
            bytedesk/freeswitch:${{ steps.version.outputs.VERSION }}
          
          echo "Waiting for container to start..."
          sleep 30
          
          echo "Checking container status..."
          docker ps -a
          
          echo "Checking container logs..."
          docker logs freeswitch-test
          
          echo "Testing FreeSWITCH status..."
          docker exec freeswitch-test fs_cli -p test123 -x "status" || true
          
          echo "Stopping test container..."
          docker stop freeswitch-test
          docker rm freeswitch-test
          
          echo "‚úÖ Image test completed!"

      - name: Test Aliyun image
        run: |
          echo "Testing Aliyun Docker Registry image..."
          docker pull registry.cn-hangzhou.aliyuncs.com/bytedesk/freeswitch:${{ steps.version.outputs.VERSION }}
          
          echo "Starting container..."
          docker run -d --name freeswitch-test-aliyun \
            -e FREESWITCH_ESL_PASSWORD=test123 \
            registry.cn-hangzhou.aliyuncs.com/bytedesk/freeswitch:${{ steps.version.outputs.VERSION }}
          
          echo "Waiting for container to start..."
          sleep 30
          
          echo "Checking container status..."
          docker ps -a
          
          echo "Stopping test container..."
          docker stop freeswitch-test-aliyun
          docker rm freeswitch-test-aliyun
          
          echo "‚úÖ Aliyun image test completed!"
